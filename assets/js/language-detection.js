/**
 * Sistema de Detec√ß√£o Autom√°tica de Idioma
 * Portfolio de Kelvin Andrade
 * 
 * Detecta idioma do navegador e redireciona automaticamente
 * Salva prefer√™ncia do usu√°rio no localStorage
 * Evita loops de redirecionamento
 * Suporte a textos de carregamento multil√≠ngues
 */

(function() {
    'use strict';

    // Configura√ß√£o de idiomas suportados
    const LANGUAGES = {
        'pt-br': 'index.html',
        'en': 'index-en.html',
        'es': 'index-es.html'
    };

    // Configura√ß√£o de blogs por idioma
    const BLOG_LANGUAGES = {
        'pt-br': 'blog/blogindex.html',
        'en': 'blog/blog-en.html',
        'es': 'blog/blog-es.html'
    };

    const DEFAULT_LANG = 'en'; // Fallback padr√£o

    // Textos de carregamento multil√≠ngues
    const LOADING_TEXTS = {
        'pt-br': {
            portfolio: 'Carregando Portf√≥lio...',
            blog: 'Carregando Blog...'
        },
        'en': {
            portfolio: 'Loading Portfolio...',
            blog: 'Loading Blog...'
        },
        'es': {
            portfolio: 'Cargando Portafolio...',
            blog: 'Cargando Blog...'
        }
    };

    /**
     * Detecta o idioma do navegador
     * @returns {string} C√≥digo do idioma (pt-br, en, es)
     */
    function detectBrowserLanguage() {
        const browserLang = (navigator.language || navigator.userLanguage).toLowerCase();
        
        // Mapear idioma do navegador para c√≥digos suportados
        if (browserLang.startsWith('pt')) {
            return 'pt-br';
        } else if (browserLang.startsWith('es')) {
            return 'es';
        } else if (browserLang.startsWith('en')) {
            return 'en';
        }
        
        return DEFAULT_LANG;
    }

    /**
     * Verifica se estamos em uma p√°gina de blog
     * @returns {boolean}
     */
    function isBlogPage() {
        const currentPath = window.location.pathname;
        return currentPath.includes('/blog/') || currentPath.includes('blogindex.html') || 
               currentPath.includes('blog-en.html') || currentPath.includes('blog-es.html');
    }

    /**
     * Obt√©m o idioma atual baseado na URL (incluindo blogs)
     * @returns {string} C√≥digo do idioma atual
     */
    function getCurrentLanguage() {
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        
        // Verificar se √© p√°gina de blog
        if (isBlogPage()) {
            for (const [lang, blogFile] of Object.entries(BLOG_LANGUAGES)) {
                if (currentPage === blogFile.split('/').pop()) {
                    return lang;
                }
            }
        }
        
        // Mapear arquivo para idioma (p√°ginas principais)
        for (const [lang, file] of Object.entries(LANGUAGES)) {
            if (currentPage === file) {
                return lang;
            }
        }
        
        return 'pt-br'; // Fallback para portugu√™s
    }

    /**
     * Atualiza o texto de carregamento conforme o idioma
     * @param {string} lang - C√≥digo do idioma
     */
    function updateLoadingText(lang) {
        const loadingText = document.querySelector('#loading-screen p');
        if (loadingText && LOADING_TEXTS[lang]) {
            const isBlogPage = window.location.pathname.includes('/blog/');
            const textType = isBlogPage ? 'blog' : 'portfolio';
            const text = LOADING_TEXTS[lang][textType];
            loadingText.textContent = text;
            console.log('üåç Texto de carregamento atualizado para:', text);
        }
    }

    /**
     * Redireciona para o idioma especificado
     * @param {string} targetLang - C√≥digo do idioma de destino
     */
    function redirectToLanguage(targetLang) {
        // Marcar que j√° foi redirecionado nesta sess√£o
        sessionStorage.setItem('languageRedirected', 'true');
        
        // Obter o caminho base (importante para GitHub Pages)
        const pathArray = window.location.pathname.split('/');
        pathArray.pop(); // Remove o arquivo atual
        const basePath = pathArray.join('/');
        
        // Determinar arquivo de destino baseado no tipo de p√°gina
        let targetFile;
        if (isBlogPage()) {
            targetFile = BLOG_LANGUAGES[targetLang];
        } else {
            targetFile = LANGUAGES[targetLang];
        }
        
        if (targetFile) {
            // Redirecionar
            window.location.href = basePath + '/' + targetFile;
        }
    }

    /**
     * Inicializa a detec√ß√£o autom√°tica de idioma
     */
    function initLanguageDetection() {
        // Verifica se j√° foi redirecionado nesta sess√£o
        const wasRedirected = sessionStorage.getItem('languageRedirected');
        if (wasRedirected) {
            console.log('‚úì Idioma j√° detectado nesta sess√£o');
            return;
        }

        // Verifica prefer√™ncia salva do usu√°rio
        const savedLang = localStorage.getItem('user_language_preference');
        
        if (!savedLang) {
            // Primeira visita - detectar idioma do navegador
            const detectedLang = detectBrowserLanguage();
            
            console.log('üåç Idioma detectado:', detectedLang);
            
            // Salvar prefer√™ncia detectada
            localStorage.setItem('user_language_preference', detectedLang);
            
            // Verificar se precisa redirecionar
            const currentLang = getCurrentLanguage();
            
            if (detectedLang !== currentLang) {
                console.log('üîÑ Redirecionando de', currentLang, 'para', detectedLang);
                redirectToLanguage(detectedLang);
            } else {
                // Marcar como redirecionado mesmo se j√° estiver no idioma correto
                sessionStorage.setItem('languageRedirected', 'true');
            }
        } else {
            // Prefer√™ncia j√° existe - verificar se est√° na p√°gina correta
            const currentLang = getCurrentLanguage();
            
            if (savedLang !== currentLang) {
                console.log('üîÑ Carregando prefer√™ncia salva:', savedLang);
                redirectToLanguage(savedLang);
            } else {
                // J√° est√° na p√°gina correta
                sessionStorage.setItem('languageRedirected', 'true');
            }
        }
    }

    // Executar detec√ß√£o ao carregar a p√°gina
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLanguageDetection);
    } else {
        initLanguageDetection();
    }

})();

/**
 * Fun√ß√£o global para trocar idioma manualmente
 * @param {string} lang - C√≥digo do idioma (pt-br, en, es)
 */
function changeLanguage(lang) {
    console.log('üîÑ Mudando idioma manualmente para:', lang);
    
    // Atualizar texto de carregamento antes do redirecionamento
    const loadingText = document.querySelector('#loading-screen p');
    if (loadingText && LOADING_TEXTS[lang]) {
        const isBlogPage = window.location.pathname.includes('/blog/');
        const textType = isBlogPage ? 'blog' : 'portfolio';
        const text = LOADING_TEXTS[lang][textType];
        loadingText.textContent = text;
        console.log('üåç Texto de carregamento atualizado para:', text);
    }
    
    // Salvar nova prefer√™ncia
    localStorage.setItem('user_language_preference', lang);
    
    // Limpar flag de redirecionamento para permitir nova navega√ß√£o
    sessionStorage.removeItem('languageRedirected');
    
    // Mapa de idiomas para arquivos
    const targetPages = {
        'pt-br': 'index.html',
        'pt': 'index.html', // Alias
        'en': 'index-en.html',
        'es': 'index-es.html'
    };
    
    // Determinar arquivo de destino baseado no tipo de p√°gina
    let targetFile;
    if (window.location.pathname.includes('/blog/') || window.location.pathname.includes('blogindex.html') || 
        window.location.pathname.includes('blog-en.html') || window.location.pathname.includes('blog-es.html')) {
        // Estamos em uma p√°gina de blog
        const blogPages = {
            'pt-br': 'blog/blogindex.html',
            'pt': 'blog/blogindex.html', // Alias
            'en': 'blog/blog-en.html',
            'es': 'blog/blog-es.html'
        };
        targetFile = blogPages[lang];
    } else {
        // P√°gina principal
        targetFile = targetPages[lang];
    }
    
    if (targetFile) {
        // Obter caminho base
        const pathArray = window.location.pathname.split('/');
        pathArray.pop();
        const basePath = pathArray.join('/');
        
        // Redirecionar
        window.location.href = basePath + '/' + targetFile;
    } else {
        console.error('‚ùå Idioma n√£o suportado:', lang);
    }
}

/**
 * Atualiza indicador visual do idioma ativo
 */
function updateActiveLanguageIndicator() {
    const currentLang = localStorage.getItem('user_language_preference') || 'pt-br';
    
    // Remover classe 'active' de todos os bot√µes
    document.querySelectorAll('.language-selector .flag, #language-switcher .flag').forEach(link => {
        link.classList.remove('active');
    });
    
    // Adicionar classe 'active' ao idioma atual
    const langMap = {
        'pt-br': 'index.html',
        'en': 'index-en.html',
        'es': 'index-es.html'
    };
    
    const targetFile = langMap[currentLang];
    if (targetFile) {
        const activeLink = document.querySelector(`.flag[href*="${targetFile}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
}

// Atualizar indicador ao carregar a p√°gina
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateActiveLanguageIndicator);
} else {
    updateActiveLanguageIndicator();
}

/**
 * Fun√ß√£o de debug - Limpar prefer√™ncias
 * Use no console: resetLanguagePreferences()
 */
function resetLanguagePreferences() {
    localStorage.removeItem('user_language_preference');
    sessionStorage.removeItem('languageRedirected');
    console.log('‚úì Prefer√™ncias de idioma resetadas');
    console.log('üîÑ Recarregue a p√°gina para detec√ß√£o autom√°tica');
}

// Expor fun√ß√£o de debug no console
window.resetLanguagePreferences = resetLanguagePreferences;

console.log('‚úì Sistema de detec√ß√£o de idioma carregado');

